<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Genetics RPG Simulator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root {
            --bg-color: #f0f0f0;
            --screen-bg: #e0f8cf;
            --dark-color: #2b2b2b;
            --border-color: #4a4a4a;
            --primary-btn: #3d6cb9;
            --accent: #d32f2f;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'VT323', monospace;
            background-color: var(--dark-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--dark-color);
            font-size: 20px;
        }
        .device-container {
            width: 100%;
            max-width: 800px;
            background-color: #dcdcdc;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 4px solid #999;
        }
        .screen {
            background-color: var(--screen-bg);
            border: 4px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            min-height: 500px;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        /* QR Screen */
        #qr-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }
        .scanner-box {
            width: 280px;
            height: 280px;
            border: 4px dashed var(--dark-color);
            margin: 20px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.03);
        }
        .scan-line {
            width: 100%;
            height: 4px;
            background-color: var(--accent);
            position: absolute;
            animation: scan 2s infinite linear;
            display: none;
        }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }

        /* video preview inside scanner */
        #qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        /* manual input fallback */
        #manual-div { margin-top: 8px; display:flex; gap:6px; align-items:center; justify-content:center; }
        #manual-input { padding:6px; font-family: 'VT323'; font-size:1rem; width:180px; }

        /* rest kept as original (game-screen styles) */
        #game-screen { display: none; flex-direction: column; height: 100%; }

        .status-bar { display: flex; justify-content: space-between; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; }

        .dialog-box { background-color: white; border: 4px double var(--dark-color); border-radius: 5px; padding: 15px; height: 120px; margin-bottom: 15px; position: relative; font-size: 1.2rem; line-height: 1.4; overflow: hidden; }

        .dialog-arrow { position: absolute; bottom: 10px; right: 15px; width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid var(--accent); animation: bounce 0.8s infinite; display: none; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }

        .choice-area { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .btn-choice { background-color: white; border: 2px solid var(--dark-color); padding: 15px; border-radius: 8px; font-family: 'VT323', monospace; font-size: 1.1rem; cursor: pointer; text-align: left; transition: transform 0.1s, background 0.2s; box-shadow: 4px 4px 0px rgba(0,0,0,0.2); }
        .btn-choice:hover { background-color: #f0f0f0; transform: translate(-2px, -2px); box-shadow: 6px 6px 0px rgba(0,0,0,0.2); }
        .btn-choice:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px; }
        .btn-choice:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }

        .notebook { flex-grow: 1; background: #fff; border: 2px solid var(--border-color); padding: 10px; overflow-y: auto; font-size: 0.9rem; max-height: 150px; margin-bottom: 15px; }
        .log-item { border-bottom: 1px dashed #ccc; padding: 4px 0; }

        .diagnosis-area { display: flex; gap: 10px; border-top: 2px solid var(--border-color); padding-top: 15px; }
        select { flex-grow: 1; padding: 8px; font-family: 'VT323', monospace; font-size: 1.1rem; border: 2px solid var(--dark-color); }
        .btn-action { background-color: var(--primary-btn); color: white; border: 2px solid var(--dark-color); padding: 8px 20px; font-family: 'VT323', monospace; font-size: 1.1rem; cursor: pointer; box-shadow: 2px 2px 0 #000; }
        .btn-hint { background-color: #ffb700; color: black; margin-bottom: 5px; width: 100%; }
        .btn-start { font-size: 1.5rem; padding: 10px 30px; margin-top: 20px; }
        #feedback-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; z-index: 100; }

    </style>
</head>
<body>

<div class="device-container">
    <div class="screen">
        <div id="qr-screen">
            <h2>üîê ACESSO RESTRITO</h2>
            <p>Para iniciar o Caso <span id="qr-case-num">1</span>, escaneie o c√≥digo do paciente.</p>

            <div class="scanner-box" id="scanner-box">
                <!-- video preview (hidden until camera ativada) -->
                <video id="qr-video" playsinline></video>
                <!-- placeholder QR image (kept for non-camera view) -->
                <img id="qr-placeholder" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=GENETICA-CASO-1" alt="QR Code Placeholder" style="opacity: 0.25;">
                <div class="scan-line" id="scan-line"></div>
            </div>

            <div style="display:flex; gap:10px; align-items:center; justify-content:center;">
                <button class="btn-action btn-start" id="start-scan-btn">üì∑ ESCANEAR QR CODE</button>
                <button class="btn-action" id="stop-scan-btn" style="display:none; background:#888;">‚úñ PARAR</button>
            </div>

            <div id="manual-div">
                <input id="manual-input" placeholder="colar conte√∫do do QR (ex: case1)" />
                <button class="btn-action" id="manual-btn">‚Ü©Ô∏è OK</button>
            </div>

            <p style="font-size: 0.8rem; margin-top: 10px;">(Use c√¢mera ou cole o conte√∫do do QR)</p>
        </div>

        <div id="game-screen">
            <div class="status-bar">
                <span id="case-display">CASO: 1/5</span>
                <span id="questions-left">PERGUNTAS: 0/10</span>
            </div>

            <div class="dialog-box" id="dialog-box">
                <span id="typewriter-text">Inicializando sistema...</span>
                <div class="dialog-arrow" id="dialog-arrow"></div>
            </div>

            <div class="choice-area" id="choice-area">
                <button class="btn-choice" id="choice-a" onclick="handleChoice('A')">Op√ß√£o A</button>
                <button class="btn-choice" id="choice-b" onclick="handleChoice('B')">Op√ß√£o B</button>
            </div>

            <button class="btn-action btn-hint" id="hint-btn" onclick="showHint()">üí° PEDIR DICA (0/3)</button>

            <div class="notebook" id="notebook">
                <strong>üìù HIST√ìRICO:</strong>
                <div id="log-content"></div>
            </div>

            <div class="diagnosis-area">
                <select id="diagnosis-select">
                    <option value="">-- SELECIONE O DIAGN√ìSTICO --</option>
                    <option value="Autoss√¥mica Dominante">Autoss√¥mica Dominante</option>
                    <option value="Autoss√¥mica Recessiva">Autoss√¥mica Recessiva</option>
                    <option value="Ligada ao X Dominante">Ligada ao X Dominante</option>
                    <option value="Ligada ao X Recessiva">Ligada ao X Recessiva</option>
                    <option value="Mitocondrial">Mitocondrial</option>
                </select>
                <button class="btn-action" onclick="submitDiagnosis()">ENVIAR</button>
            </div>
        </div>

        <div id="feedback-overlay">
            <h1 id="feedback-title">RESULTADO</h1>
            <p id="feedback-msg">Mensagem...</p>
            <button class="btn-action btn-start" id="next-level-btn" onclick="nextLevel()">PR√ìXIMO CASO ‚ûî</button>
        </div>
    </div>
</div>

<!-- jsQR library (decodificador do QR a partir de imagem/canvas) -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
    // --- DADOS DOS CASOS (mantidos conforme seu original) ---
    const cases = [
        { id: 1, qrCode: "GENE-01", intro: "Paciente: Carlos, 35 anos. 'Doutor, notei que meus dedos s√£o diferentes e meus filhos tamb√©m t√™m isso.'", inheritance: "Autoss√¥mica Dominante", explanation: "AD: Transmiss√£o vertical (pais e filhos afetados). Afeta ambos os sexos. Basta um alelo para manifestar.", data: { "pais": "Minha m√£e tem a mesma condi√ß√£o que eu. Meu pai n√£o tem nada.", "irmaos": "Tenho uma irm√£ que tamb√©m tem. Meu irm√£o ca√ßula nasceu sem nada.", "filhos": "Tenho dois filhos com isso e uma filha sem.", "transmissao": "Parece que vem vindo de gera√ß√£o em gera√ß√£o. Minha av√≥ materna tamb√©m tinha.", "sexo": "N√£o vejo diferen√ßa, homens e mulheres na fam√≠lia t√™m.", "consanguinidade": "N√£o, meus pais n√£o s√£o parentes.", "filhas_pai": "N√£o sei dizer sobre essa regra espec√≠fica.", "gravidade": "√â s√≥ f√≠sico (polidactilia), vivemos bem.","informa√ß√£o": "Minha Tia por parte de m√£e √© adotada" }, hints: ["Transmiss√£o Vertical (todas as gera√ß√µes).", "Afeta homens e mulheres igualmente.", "Um pai afetado tem 50% de chance de passar."] },
        { id: 2, qrCode: "GENE-02", intro: "Paciente: Luiza, 28 anos. 'Ningu√©m na minha fam√≠lia tinha isso antes de mim e do meu irm√£o.'", inheritance: "Autoss√¥mica Recessiva", explanation: "AR: Salta gera√ß√µes (pais portadores sadios). Consanguinidade aumenta o risco.", data: { "pais": "Meus pais s√£o saud√°veis, gra√ßas a Deus. Nenhum deles tem isso.", "irmaos": "Meu irm√£o tamb√©m tem a doen√ßa. Minha irm√£ √© saud√°vel.", "filhos": "Ainda n√£o tenho filhos.", "transmissao": "Saltou a gera√ß√£o dos meus pais. Meus av√≥s tamb√©m n√£o tinham.", "sexo": "Afetou eu e meu irm√£o.", "consanguinidade": "Meus pais s√£o primos de segundo grau.", "filhas_pai": "N√£o se aplica, meus pais n√£o s√£o afetados.", "gravidade": "√â uma condi√ß√£o metab√≥lica s√©ria (Fibrose C√≠stica).","informa√ß√£o": "Lembrei! Meus av√≥s portavam a doen√ßa"}, hints: ["Pais n√£o afetados (Portadores).", "Salta gera√ß√µes (Transmiss√£o Horizontal).", "Consanguinidade √© um fator de risco."] },
        { id: 3, qrCode: "GENE-03", intro: "Paciente: Roni, 12 anos. 'Eu sangro muito quando me machuco. Meu tio tamb√©m.'", inheritance: "Ligada ao X Recessiva", explanation: "XR: Afeta mais homens. M√£es portadoras transmitem para filhos. Pai nunca passa para filho homem.", data: { "pais": "Meu pai √© normal. Minha m√£e tamb√©m, mas dizem que ela carrega o gene.", "irmaos": "Meus irm√£os gemeos, Hugo e Luis est√£o bem. S√≥ eu tenho.", "filhos": "Eu? N√£o.", "transmissao": "Meu av√¥ materno tinha. Pulou minha m√£e e veio pra mim.", "sexo": "S√≥ vi homens com isso na minha fam√≠lia.", "consanguinidade": "N√£o.", "filhas_pai": "Meu av√¥ era doente, e teve minha m√£e que √© normal.", "gravidade": "√â hemofilia.", "informa√ß√µes": "Um Tio por parte de m√£e tinha, e se separou" }, hints: ["Afeta principalmente homens.", "M√£e portadora transmite para filho.", "Pai afetado N√ÉO transmite para filho homem."] },
        { id: 4, qrCode: "GENE-04", intro: "Paciente: Ana, 30 anos. 'Eu e todos os meus irm√£os temos esse problema de energia.'", inheritance: "Mitocondrial", explanation: "Mitocondrial: Apenas a m√£e transmite. Se a m√£e tem, TODOS os filhos t√™m.", data: { "pais": "Minha m√£e tem a doen√ßa. Meu pai √© saud√°vel.", "irmaos": "Todos n√≥s, meus dois irm√£os e minha irm√£, temos a doen√ßa.", "filhos": "Minha filha e meus dois filhos nasceram com isso tamb√©m.", "transmissao": "Vem tudo da minha m√£e.", "sexo": "Afeta todo mundo (irm√£os e filhos).", "consanguinidade": "N√£o.", "filhas_pai": "Meu irm√£o teve um filho saud√°vel. Ele n√£o passou.", "gravidade": "√â uma miopatia.","informa√ß√µes": "Minha M√£e √© adotada." }, hints: ["Transmiss√£o Materna Exclusiva.", "M√£e afetada passa para 100% dos filhos.", "Pai afetado n√£o transmite nada."] },
        { id: 5, qrCode: "GENE-05", intro: "Paciente: Lara, 8 anos. 'Minha m√£e tem, minha av√≥ tem....'", inheritance: "Ligada ao X Dominante", explanation: "XD: Pai afetado transmite para TODAS as filhas e NENHUM filho. Afeta mais mulheres.", data: { "pais": "Minha m√£e √© doente. Meu Pai √© normal.", "irmaos": "Minha irm√£ tem. Meu irm√£o nasceu normal.", "filhos": "Sou crian√ßa ainda!", "transmissao": "Minha av√≥ tinha, passou pra minha m√£e, que passou pra mim.", "sexo": "Tem muito mais mulher com isso.", "consanguinidade": "N√£o.", "filhas_pai": "Papai n√£o tem...", "gravidade": "N√£o sei, alguma coisa Rett...","informa√ß√£o": "Posso ir embora?" }, hints: ["Afeta mais mulheres.", "Pai afetado transmite para TODAS as filhas.", "Transmiss√£o vertical."] }
    ];

    // Perguntas (mantidas)
    const questionPool = [
        { id: "pais", text: "Como s√£o seus pais?" },
        { id: "irmaos", text: "Voc√™ tem irm√£os afetados?" },
        { id: "filhos", text: "Voc√™ tem filhos afetados?" },
        { id: "transmissao", text: "Como √© a transmiss√£o nas gera√ß√µes?" },
        { id: "sexo", text: "Afeta mais homens ou mulheres?" },
        { id: "consanguinidade", text: "H√° parentesco entre seus pais?" },
        { id: "filhas_pai", text: "Como √© a transmiss√£o do pai?" },
        { id: "gravidade", text: "Qual a gravidade/tipo da doen√ßa?" },
        {id: "informa√ß√£o", text: "Mais algo a adicionar?"}
    ];

    // --- ESTADO ---
    let currentLevel = 0;
    let usedQuestions = 0;
    let askedQuestionIds = [];
    let currentChoices = [];
    let hintCount = 0;

    // DOM
    const qrScreen = document.getElementById('qr-screen');
    const gameScreen = document.getElementById('game-screen');
    const dialogBox = document.getElementById('typewriter-text');
    const dialogArrow = document.getElementById('dialog-arrow');
    const choiceBtnA = document.getElementById('choice-a');
    const choiceBtnB = document.getElementById('choice-b');
    const logContent = document.getElementById('log-content');
    const scanLine = document.getElementById('scan-line');
    const feedbackOverlay = document.getElementById('feedback-overlay');
    const btnHint = document.getElementById('hint-btn');
    const qrCaseNum = document.getElementById('qr-case-num');

    // NEW: video and canvas for scanning
    const video = document.getElementById('qr-video');
    const qrPlaceholder = document.getElementById('qr-placeholder');
    const startScanBtn = document.getElementById('start-scan-btn');
    const stopScanBtn = document.getElementById('stop-scan-btn');
    const manualInput = document.getElementById('manual-input');
    const manualBtn = document.getElementById('manual-btn');

    let scanning = false;
    let scanRequestId = null;
    let localStream = null;
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    // ---- Atualiza indicador do caso na tela de QR
    function updateQRScreen() {
        qrCaseNum.innerText = currentLevel + 1;
        scanLine.style.display = 'none';
        video.style.display = 'none';
        qrPlaceholder.style.display = 'block';
        stopCamera();
    }

    // ---- Fun√ß√£o para iniciar c√¢mera e scanning
    async function startCameraAndScan() {
        // pedir permiss√£o e abrir c√¢mera traseira
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
            localStream = stream;
            video.srcObject = stream;
            await video.play();
            video.style.display = 'block';
            qrPlaceholder.style.display = 'none';
            scanLine.style.display = 'block';
            startScanBtn.style.display = 'none';
            stopScanBtn.style.display = 'inline-block';
            scanning = true;

            // ajustar canvas ao v√≠deo
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;

            tickScan();
        } catch (err) {
            console.error("Erro ao abrir c√¢mera:", err);
            alert("N√£o foi poss√≠vel acessar a c√¢mera. Cole o conte√∫do do QR manualmente.");
        }
    }

    function stopCamera() {
        scanning = false;
        if (scanRequestId) {
            cancelAnimationFrame(scanRequestId);
            scanRequestId = null;
        }
        if (localStream) {
            localStream.getTracks().forEach(t => t.stop());
            localStream = null;
        }
        video.pause();
        video.srcObject = null;
        startScanBtn.style.display = 'inline-block';
        stopScanBtn.style.display = 'none';
        scanLine.style.display = 'none';
        video.style.display = 'none';
        qrPlaceholder.style.display = 'block';
    }

    // loop que captura frame e tenta decodificar com jsQR
    function tickScan() {
        if (!scanning) return;
        try {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                if (code && code.data) {
                    // encontrado
                    handleScannedCode(code.data);
                    return;
                }
            }
        } catch (e) {
            console.error("Erro durante scan:", e);
        }
        scanRequestId = requestAnimationFrame(tickScan);
    }

    // --- NORMALIZA E COMPARA O TEXTO LIDO COM OS CASES ---
    function normalizeText(s) {
        if (!s) return "";
        return s.toString().toLowerCase().replace(/[^a-z0-9]/g, '');
    }

    function matchCaseFromScanned(text) {
        const norm = normalizeText(text);
        // tenta casar com qrCode (ex: GENE-01), ou com "case<number>" (case1), ou "case<number>" com h√≠fen etc.
        for (let i = 0; i < cases.length; i++) {
            const c = cases[i];
            const qrNorm = normalizeText(c.qrCode);
            if (norm.includes(qrNorm) || norm === qrNorm) return i;
            const caseIdNorm = normalizeText('case' + c.id);
            if (norm.includes(caseIdNorm) || norm === caseIdNorm) return i;
        }
        return -1;
    }

    function handleScannedCode(data) {
        // mostra toast m√≠nimo (alert) e tenta casar
        stopCamera();
        const matchedIdx = matchCaseFromScanned(data);
        if (matchedIdx >= 0) {
            currentLevel = matchedIdx;
            qrScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
            startGame();
        } else {
            // se n√£o casar automaticamente, perguntar ao usu√°rio se quer abrir caso 1 por exemplo
            const tryOpen = confirm("QR lido: '" + data + "'. N√£o encontrei um caso correspondente automaticamente. Deseja usar este valor como entrada manual?");
            if (tryOpen) {
                // usar entrada manual: tentar mapear por n√∫mero dentro do texto
                const foundNumber = data.match(/\d+/);
                if (foundNumber) {
                    const num = parseInt(foundNumber[0], 10);
                    if (!isNaN(num) && num >= 1 && num <= cases.length) {
                        currentLevel = num - 1;
                        qrScreen.style.display = 'none';
                        gameScreen.style.display = 'flex';
                        startGame();
                        return;
                    }
                }
                // sen√£o apenas mostrar mensagem e voltar √† tela QR
                alert("N√£o foi poss√≠vel mapear automaticamente. Volte √† tela de escaneamento ou cole o c√≥digo manualmente.");
                updateQRScreen();
            } else {
                updateQRScreen();
            }
        }
    }

    // Manual paste handler
    manualBtn.addEventListener('click', () => {
        const txt = manualInput.value.trim();
        if (!txt) { alert("Cole o conte√∫do do QR no campo."); return; }
        const matchedIdx = matchCaseFromScanned(txt);
        if (matchedIdx >= 0) {
            currentLevel = matchedIdx;
            qrScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
            startGame();
        } else {
            // tenta n√∫mero
            const foundNumber = txt.match(/\d+/);
            if (foundNumber) {
                const num = parseInt(foundNumber[0], 10);
                if (!isNaN(num) && num >= 1 && num <= cases.length) {
                    currentLevel = num - 1;
                    qrScreen.style.display = 'none';
                    gameScreen.style.display = 'flex';
                    startGame();
                    return;
                }
            }
            alert("N√£o foi poss√≠vel encontrar um caso correspondente ao texto inserido.");
        }
    });

    // start/stop scan buttons
    startScanBtn.addEventListener('click', () => startCameraAndScan());
    stopScanBtn.addEventListener('click', () => { stopCamera(); });

    // --- ENGINE DE TEXTO (Typewriter) --- (mantive igual)
    let typingTimer;
    function typeText(text, callback) {
        dialogBox.innerHTML = "";
        dialogArrow.style.display = "none";
        let i = 0;
        if (typingTimer) clearInterval(typingTimer);
        typingTimer = setInterval(() => {
            dialogBox.innerHTML += text.charAt(i);
            i++;
            if (i >= text.length) {
                clearInterval(typingTimer);
                dialogArrow.style.display = "block";
                if (callback) callback();
            }
        }, 25);
    }

    // --- L√ìGICA DO JOGO --- (mantida, apenas refer√™ncias)
    function startGame() {
        usedQuestions = 0;
        askedQuestionIds = [];
        hintCount = 0;
        logContent.innerHTML = "";
        document.getElementById('case-display').innerText = `CASO: ${currentLevel + 1}/${cases.length}`;
        document.getElementById('questions-left').innerText = `PERGUNTAS: 0/7`;
        document.getElementById('diagnosis-select').value = "";
        btnHint.innerText = "üí° PEDIR DICA (0/3)";
        btnHint.disabled = false;

        const introText = cases[currentLevel].intro;
        typeText(introText, () => { generateChoices(); });
    }

    function generateChoices() {
        if (usedQuestions >= 7) {
            typeText("Voc√™ atingiu o limite de perguntas. Tente diagnosticar ou pe√ßa uma dica.");
            choiceBtnA.style.display = 'none';
            choiceBtnB.style.display = 'none';
            return;
        }
        const available = questionPool.filter(q => !askedQuestionIds.includes(q.id));
        if (available.length < 2) {
            typeText("N√£o tenho mais informa√ß√µes para dar.");
            choiceBtnA.style.display = 'none';
            choiceBtnB.style.display = 'none';
            return;
        }
        const shuffled = available.sort(() => 0.5 - Math.random());
        currentChoices = [shuffled[0], shuffled[1]];
        choiceBtnA.style.display = 'block';
        choiceBtnB.style.display = 'block';
        choiceBtnA.innerText = "‚û§ " + currentChoices[0].text;
        choiceBtnB.innerText = "‚û§ " + currentChoices[1].text;
        choiceBtnA.disabled = false;
        choiceBtnB.disabled = false;
    }

    function handleChoice(option) {
        choiceBtnA.disabled = true;
        choiceBtnB.disabled = true;
        const selectedQ = option === 'A' ? currentChoices[0] : currentChoices[1];
        askedQuestionIds.push(selectedQ.id);
        usedQuestions++;
        document.getElementById('questions-left').innerText = `PERGUNTAS: ${usedQuestions}/10`;
        const caseData = cases[currentLevel].data;
        const answer = caseData[selectedQ.id];
        const logEntry = document.createElement('div');
        logEntry.className = 'log-item';
        logEntry.innerHTML = `<strong>P:</strong> ${selectedQ.text}<br><strong>R:</strong> ${answer}`;
        logContent.appendChild(logEntry);
        logContent.scrollTop = logContent.scrollHeight;
        typeText(answer, () => { setTimeout(generateChoices, 500); });
    }

    function showHint() {
        if (hintCount >= 3) { typeText("N√£o h√° mais dicas dispon√≠veis."); return; }
        const hint = cases[currentLevel].hints[hintCount];
        hintCount++;
        btnHint.innerText = `üí° PEDIR DICA (${hintCount}/3)`;
        const logEntry = document.createElement('div');
        logEntry.className = 'log-item';
        logEntry.style.backgroundColor = "#fff3cd";
        logEntry.innerHTML = `<strong>üí° DICA:</strong> ${hint}`;
        logContent.appendChild(logEntry);
        logContent.scrollTop = logContent.scrollHeight;
        typeText(`DICA REVELADA: ${hint}`);
    }

    function submitDiagnosis() {
        const selected = document.getElementById('diagnosis-select').value;
        const correct = cases[currentLevel].inheritance;
        feedbackOverlay.style.display = 'flex';
        if (selected === correct) {
            document.getElementById('feedback-title').innerText = "‚úÖ SUCESSO!";
            document.getElementById('feedback-title').style.color = "#4eff4e";
            document.getElementById('feedback-msg').innerHTML = `Diagn√≥stico Correto!<br><br>${cases[currentLevel].explanation}`;
            document.getElementById('next-level-btn').innerText = "PR√ìXIMO CASO ‚ûî";
            document.getElementById('next-level-btn').onclick = nextLevel;
        } else {
            document.getElementById('feedback-title').innerText = "‚ùå ERRO";
            document.getElementById('feedback-title').style.color = "#ff4e4e";
            document.getElementById('feedback-msg').innerText = `Diagn√≥stico Incorreto. Voc√™ escolheu ${selected}. Analise o log e tente novamente.`;
            document.getElementById('next-level-btn').innerText = "TENTAR NOVAMENTE";
            document.getElementById('next-level-btn').onclick = closeFeedback;
        }
    }

    function closeFeedback() { feedbackOverlay.style.display = 'none'; }

    function nextLevel() {
        feedbackOverlay.style.display = 'none';
        currentLevel++;
        if (currentLevel >= cases.length) {
            alert("PARAB√âNS! Voc√™ completou todos os casos cl√≠nicos.");
            currentLevel = 0;
        }
        gameScreen.style.display = 'none';
        qrScreen.style.display = 'flex';
        updateQRScreen();
    }

    // Inicializa√ß√£o
    updateQRScreen();

    // seguran√ßa: parar c√¢mera ao sair da aba
    window.addEventListener('beforeunload', stopCamera);

</script>

</body>
</html>
