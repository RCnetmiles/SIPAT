<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heran√ßa Gen√©tica - Casos Cl√≠nicos</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #eef2ff, #dbeafe);
    color: #1e293b;
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 600px;
    margin: auto;
    padding: 16px;
  }
  h1 {
    text-align: center;
    color: #1e3a8a;
  }
  #scanner, #case-area {
    margin-top: 20px;
  }
  #reader {
    width: 100%;
    height: auto;
  }
  #chat {
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    margin-bottom: 10px;
    background-color: #f9fafb;
    display: flex;
    flex-direction: column;
  }
  .message {
    margin: 8px 0;
    padding: 10px 14px;
    border-radius: 16px;
    max-width: 80%;
    line-height: 1.4;
  }
  .npc { background-color: #e0e7ff; align-self: flex-start; }
  .user { background-color: #bfdbfe; align-self: flex-end; margin-left: auto; }
  #options {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  button {
    padding: 12px;
    border: none;
    border-radius: 10px;
    background-color: #3b82f6;
    color: white;
    font-weight: 500;
    cursor: pointer;
    transition: 0.2s;
  }
  button:hover { background-color: #2563eb; }
  .typing { font-style: italic; color: #6b7280; }
  .score {
    text-align: center;
    font-weight: bold;
    color: #16a34a;
    margin-top: 10px;
  }
  @media (max-width: 600px) {
    h1 { font-size: 1.4em; }
    button { font-size: 0.9em; }
  }
</style>
</head>
<body>
<div class="container">
  <h1>üß¨ Heran√ßa Gen√©tica - Casos Cl√≠nicos</h1>

  <div id="scanner">
    <p>Escaneie o QR Code do caso cl√≠nico para come√ßar:</p>
    <div id="reader"></div>
    <p class="score">Pontua√ß√£o atual: <span id="score-display">0</span> pts</p>
  </div>

  <div id="case-area" style="display:none;">
    <p id="case-desc"></p>
    <div id="chat"></div>
    <div id="options"></div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
/* ===========================
   Casos Cl√≠nicos
   =========================== */
const cases = {
  "case1": {
    id: "case1",
    title: "Caso Cl√≠nico 1 - Distrofia Muscular",
    description: "Paciente de 12 anos com fraqueza muscular progressiva. H√° suspeita de condi√ß√£o gen√©tica. Descubra o tipo de heran√ßa.",
    dialogue: [
      { questions: ["Algum dos pais √© afetado?", "Algum dos pais √© portador?"], answers: ["Nenhum dos pais apresenta sintomas vis√≠veis.", "A m√£e √© portadora confirmada da muta√ß√£o, mas n√£o apresenta sintomas cl√≠nicos."] },
      { questions: ["H√° outros casos na fam√≠lia?", "Os irm√£os s√£o afetados?"], answers: ["Sim, h√° dois tios maternos que tiveram sintomas semelhantes.", "O irm√£o mais velho tamb√©m apresenta sintomas."] },
      { questions: ["As meninas tamb√©m s√£o afetadas?", "H√° diferen√ßa entre meninos e meninas?"], answers: ["As meninas geralmente n√£o apresentam sintomas, mas podem ser portadoras.", "A condi√ß√£o √© observada apenas nos meninos da fam√≠lia."] },
      { questions: ["H√° casos em gera√ß√µes anteriores?", "O av√¥ paterno teve sintomas?"], answers: ["O av√¥ materno teve sintomas semelhantes.", "No lado paterno, n√£o h√° registros."] },
      { questions: ["A m√£e do paciente apresenta a muta√ß√£o?", "O pai apresenta sintomas?"], answers: ["Sim, a m√£e apresenta a muta√ß√£o em heterozigose.", "N√£o, o pai √© completamente saud√°vel."] },
      { questions: ["A transmiss√£o ocorre apenas por m√£es?", "Pais passam o gene para filhos homens?"], answers: ["Sim, o gene √© transmitido por m√£es para filhos homens.", "N√£o, pais n√£o passam o gene para filhos homens."] }
    ],
    correct: "Ligada ao X Recessiva",
    tip: "üí° Dica: Apenas meninos afetados e m√£es portadoras ‚Äî isso indica heran√ßa **ligada ao X recessiva**."
  }
};

/* ===========================
   Controle de Pontua√ß√£o
   =========================== */
function setScore(points) {
  let current = parseInt(getScore());
  const newScore = current + points;
  document.cookie = "score=" + newScore + ";path=/";
  document.getElementById('score-display').textContent = newScore;
}
function getScore() {
  const name = "score=";
  const ca = document.cookie.split(';');
  for (let c of ca) {
    c = c.trim();
    if (c.indexOf(name) === 0) return c.substring(name.length);
  }
  return "0";
}

/* ===========================
   Vari√°veis Globais
   =========================== */
let step = 0, maxSteps = 6, currentCase = null, usedTip = false;
const chatBox = document.getElementById('chat');

/* ===========================
   Fun√ß√µes do Chat
   =========================== */
function appendMessage(sender, text) {
  const msg = document.createElement('div');
  msg.classList.add('message', sender);
  msg.textContent = text;
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function typeWriter(text, callback) {
  const typing = document.createElement('div');
  typing.classList.add('typing');
  typing.textContent = "NPC est√° digitando...";
  chatBox.appendChild(typing);
  chatBox.scrollTop = chatBox.scrollHeight;
  setTimeout(() => {
    typing.remove();
    appendMessage('npc', text);
    if (callback) callback();
  }, 1000 + Math.random() * 800);
}

function nextStep() {
  const options = document.getElementById('options');
  options.innerHTML = '';
  if (step >= maxSteps) {
    endCase();
    return;
  }
  const qData = currentCase.dialogue[step];
  const btn1 = document.createElement('button');
  const btn2 = document.createElement('button');
  btn1.textContent = qData.questions[0];
  btn2.textContent = qData.questions[1];
  btn1.onclick = () => chooseOption(0);
  btn2.onclick = () => chooseOption(1);
  options.appendChild(btn1);
  options.appendChild(btn2);
}

function chooseOption(i) {
  const qData = currentCase.dialogue[step];
  appendMessage('user', qData.questions[i]);
  typeWriter(qData.answers[i], () => {
    step++;
    nextStep();
  });
}

function endCase() {
  const options = document.getElementById('options');
  options.innerHTML = '';
  appendMessage('npc', "Essas foram todas as perguntas! Agora escolha o tipo de heran√ßa gen√©tica:");
  const choices = ["Autoss√¥mica Dominante", "Autoss√¥mica Recessiva", "Ligada ao X Recessiva", "Ligada ao X Dominante"];
  choices.forEach(opt => {
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.onclick = () => verifyAnswer(opt);
    options.appendChild(btn);
  });
  const tipBtn = document.createElement('button');
  tipBtn.textContent = "Mostrar dica üí°";
  tipBtn.style.backgroundColor = "#f59e0b";
  tipBtn.onclick = () => showTip();
  options.appendChild(tipBtn);
}

function showTip() {
  if (!usedTip) {
    appendMessage('npc', currentCase.tip);
    usedTip = true;
  }
}

function verifyAnswer(choice) {
  const options = document.getElementById('options');
  options.innerHTML = '';
  if (choice === currentCase.correct) {
    appendMessage('npc', "‚úÖ Correto! Excelente dedu√ß√£o!");
    if (usedTip) setScore(50);
    else setScore(100);
  } else {
    appendMessage('npc', "‚ùå Resposta incorreta. Reveja as pistas do caso.");
  }

  const backBtn = document.createElement('button');
  backBtn.textContent = "Voltar ao leitor de QR Code";
  backBtn.onclick = () => {
    document.getElementById('case-area').style.display = 'none';
    document.getElementById('scanner').style.display = 'block';
    document.getElementById('score-display').textContent = getScore();
    step = 0;
    usedTip = false;
    initQRScanner();
  };
  options.appendChild(backBtn);
}

/* ===========================
   Iniciar Caso
   =========================== */
function startCase(caseId) {
  currentCase = cases[caseId];
  if (!currentCase) {
    alert("Caso n√£o encontrado!");
    return;
  }
  document.getElementById('scanner').style.display = 'none';
  document.getElementById('case-area').style.display = 'block';
  document.getElementById('case-desc').innerHTML = `<strong>${currentCase.title}</strong><br>${currentCase.description}`;
  chatBox.innerHTML = '';
  document.getElementById('options').innerHTML = '';
  step = 0;
  usedTip = false;
  typeWriter("Ol√°! üëã Eu sou o NPC gen√©tico. Voc√™ pode fazer at√© 6 perguntas para descobrir o tipo de heran√ßa deste caso.", () => {
    nextStep();
  });
}

/* ===========================
   Leitor de QR Code
   =========================== */
function initQRScanner() {
  document.getElementById('score-display').textContent = getScore();
  const html5QrCode = new Html5Qrcode("reader");
  const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

  html5QrCode.start(
    { facingMode: "environment" },
    qrConfig,
    (decodedText) => {
      html5QrCode.stop().then(() => {
        startCase(decodedText.trim());
      });
    },
    (errorMessage) => {}
  ).catch(() => {
    document.getElementById('reader').innerHTML = "<p style='color:red;'>Erro ao acessar c√¢mera. Verifique as permiss√µes.</p>";
  });
}

window.onload = initQRScanner;
</script>
</body>
</html>
