<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heran√ßa Gen√©tica - Chat Interativo</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #e0f2fe, #dbeafe);
  margin: 0; color: #1e3a8a;
}
.container {
  max-width: 600px; margin: auto; padding: 16px;
}
h1, h2 { text-align: center; }
#video { width: 100%; border-radius: 12px; margin-top: 10px; display: none; }
canvas { display: none; }
#qr-section, #chat-section { display: none; }
#chat {
  background: #fff; border-radius: 12px; padding: 10px;
  height: 400px; overflow-y: auto; border: 1px solid #cbd5e1;
}
.message { margin: 8px 0; padding: 10px 14px; border-radius: 16px; max-width: 80%; }
.npc { background: #e0e7ff; align-self: flex-start; }
.user { background: #bfdbfe; margin-left: auto; }
#options button, #final-options button {
  display: block; width: 100%; margin: 6px 0; padding: 10px;
  border: none; border-radius: 10px; background-color: #3b82f6;
  color: white; font-weight: 500; cursor: pointer;
}
#options button:hover, #final-options button:hover { background-color: #2563eb; }
.typing { font-style: italic; color: #6b7280; }
#score { text-align: center; margin-bottom: 10px; font-size: 18px; color: #0f172a; }
#dica {
  background-color: #fef9c3; border: 1px solid #facc15; padding: 10px;
  border-radius: 10px; margin: 10px 0; display: none; text-align: center;
}
@media (max-width: 600px) { #chat { height: 60vh; } }
</style>
</head>
<body>
<div class="container">
  <h1>üß¨ Heran√ßa Gen√©tica</h1>
  <div id="qr-section">
    <h2>Leitor de QR Code</h2>
    <p>Pontua√ß√£o total: <strong id="total-score">0 pts</strong></p>
    <video id="video"></video>
    <canvas id="canvas" hidden></canvas>
    <p>Ou selecione um caso manualmente:</p>
    <button onclick="startCase('case1')">Caso Cl√≠nico 1</button>
    <button onclick="startCase('case2')">Caso Cl√≠nico 2</button>
  </div>

  <div id="chat-section">
    <h2 id="case-title"></h2>
    <div id="chat"></div>
    <div id="options"></div>
    <div id="dica"></div>
    <div id="final-options"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
const cases = {
  case1: {
    title: "Caso Cl√≠nico 1 - Fraqueza Muscular Progressiva",
    type: "Ligada ao X Recessiva",
    pairs: [
      [
        { q: "Algum dos pais √© afetado?", a: "Nenhum dos pais apresenta sintomas vis√≠veis." },
        { q: "A m√£e √© portadora?", a: "Sim, a m√£e √© portadora confirmada da muta√ß√£o." }
      ],
      [
        { q: "H√° casos no lado materno?", a: "Sim, dois tios maternos tiveram sintomas semelhantes." },
        { q: "H√° casos no lado paterno?", a: "N√£o, o lado paterno da fam√≠lia n√£o apresenta registros." }
      ],
      [
        { q: "Homens e mulheres s√£o igualmente afetados?", a: "A condi√ß√£o ocorre apenas em meninos da fam√≠lia." },
        { q: "As meninas tamb√©m adoecem?", a: "Elas geralmente n√£o t√™m sintomas, mas podem ser portadoras." }
      ],
      [
        { q: "O paciente tem irm√£os afetados?", a: "Sim, o irm√£o mais velho apresenta sintomas parecidos." },
        { q: "H√° casos em gera√ß√µes anteriores?", a: "O av√¥ materno apresentou sintomas na juventude." }
      ],
      [
        { q: "Os pais s√£o consangu√≠neos?", a: "N√£o h√° parentesco entre os pais." },
        { q: "Os sintomas surgem desde o nascimento?", a: "Aparecem gradualmente na inf√¢ncia." }
      ],
      [
        { q: "A gravidade varia entre irm√£os?", a: "Sim, h√° leve diferen√ßa, mas ambos s√£o afetados." },
        { q: "O pai teve sintomas semelhantes?", a: "N√£o, o pai √© completamente saud√°vel." }
      ]
    ],
    dica: "Os meninos afetados herdaram o gene mutado de m√£es portadoras. Heran√ßa ligada ao X recessiva."
  },
  case2: {
    title: "Caso Cl√≠nico 2 - Altera√ß√µes Cut√¢neas e Auditivas",
    type: "Autoss√¥mica Dominante",
    pairs: [
      [
        { q: "Algum dos pais √© afetado?", a: "Sim, o pai tamb√©m tem manchas cut√¢neas e perda auditiva leve." },
        { q: "A m√£e apresenta sintomas?", a: "N√£o, a m√£e n√£o tem qualquer manifesta√ß√£o da condi√ß√£o." }
      ],
      [
        { q: "H√° casos em todas as gera√ß√µes?", a: "Sim, h√° afetados em todas as gera√ß√µes conhecidas." },
        { q: "A doen√ßa pulou alguma gera√ß√£o?", a: "N√£o, sempre h√° pelo menos um afetado em cada gera√ß√£o." }
      ],
      [
        { q: "Homens e mulheres s√£o igualmente afetados?", a: "Sim, ambos os sexos t√™m chance semelhante de manifesta√ß√£o." },
        { q: "A gravidade √© diferente entre sexos?", a: "N√£o, n√£o h√° diferen√ßa significativa entre homens e mulheres." }
      ],
      [
        { q: "H√° portadores assintom√°ticos?", a: "N√£o, quem herda o gene manifesta algum sintoma." },
        { q: "H√° consanguinidade nos casamentos?", a: "N√£o h√° registros de consanguinidade." }
      ],
      [
        { q: "A condi√ß√£o piora nas gera√ß√µes seguintes?", a: "N√£o, a gravidade permanece semelhante entre gera√ß√µes." },
        { q: "H√° g√™meos com sintomas diferentes?", a: "Sim, g√™meos id√™nticos t√™m intensidade diferente dos sintomas." }
      ],
      [
        { q: "H√° membros adotados?", a: "N√£o, todos s√£o biol√≥gicos." },
        { q: "Os sintomas aparecem cedo?", a: "Sim, geralmente na inf√¢ncia ou adolesc√™ncia." }
      ]
    ],
    dica: "Afeta homens e mulheres igualmente e aparece em todas as gera√ß√µes ‚Äî padr√£o autoss√¥mico dominante."
  }
};

let selectedCase = null, step = 0, usedDica = false, score = 0;
const chat = document.getElementById("chat"), options = document.getElementById("options");

function appendMessage(sender, text) {
  const msg = document.createElement("div");
  msg.classList.add("message", sender);
  msg.textContent = text;
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
}

function typeWriter(text, callback) {
  const typing = document.createElement("div");
  typing.classList.add("typing");
  typing.textContent = "NPC est√° digitando...";
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;
  setTimeout(() => {
    chat.removeChild(typing);
    appendMessage("npc", text);
    if (callback) callback();
  }, 1000 + Math.random() * 800);
}

function getCookie(name) {
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? parseInt(m.pop()) : 0;
}
function setCookie(name, val) { document.cookie = `${name}=${val}; path=/; max-age=31536000`; }
function updateTotalScore() { document.getElementById("total-score").textContent = `${getCookie("geneticScore")} pts`; }

function startCase(id) {
  selectedCase = cases[id];
  step = 0; usedDica = false; score = 0;
  document.getElementById("qr-section").style.display = "none";
  document.getElementById("chat-section").style.display = "block";
  document.getElementById("case-title").textContent = selectedCase.title;
  chat.innerHTML = ""; options.innerHTML = ""; document.getElementById("final-options").innerHTML = "";
  appendMessage("npc", "Ol√°! üëã Sou o assistente gen√©tico. Voc√™ pode fazer at√© 6 perguntas. Escolha entre as op√ß√µes abaixo:");
  nextPair();
}

function nextPair() {
  options.innerHTML = "";
  if (step >= 6) return showFinalOptions();
  const pair = selectedCase.pairs[step];
  pair.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.textContent = opt.q;
    btn.onclick = () => chooseOption(pair[i]);
    options.appendChild(btn);
  });
}

function chooseOption(option) {
  appendMessage("user", option.q);
  options.innerHTML = "";
  typeWriter(option.a, () => {
    step++;
    nextPair();
  });
}

function showFinalOptions() {
  options.innerHTML = "";
  const final = document.getElementById("final-options");
  final.innerHTML = "<h3>Qual o tipo de heran√ßa gen√©tica?</h3>";
  ["Autoss√¥mica Dominante", "Autoss√¥mica Recessiva", "Ligada ao X Recessiva", "Ligada ao X Dominante"].forEach(type => {
    const btn = document.createElement("button");
    btn.textContent = type;
    btn.onclick = () => verifyAnswer(type);
    final.appendChild(btn);
  });
  const dicaBtn = document.createElement("button");
  dicaBtn.textContent = "üí° Mostrar Dica";
  dicaBtn.onclick = showDica;
  final.appendChild(dicaBtn);
}

function showDica() {
  usedDica = true;
  const dicaDiv = document.getElementById("dica");
  dicaDiv.style.display = "block";
  dicaDiv.textContent = "üí° Dica: " + selectedCase.dica;
}

function verifyAnswer(ans) {
  const final = document.getElementById("final-options");
  final.innerHTML = "";
  let correct = (ans === selectedCase.type);
  score = correct ? (usedDica ? 50 : 100) : 0;
  appendMessage("npc", correct ? "‚úÖ Correto! Excelente trabalho!" : "‚ùå Incorreto. Reveja as pistas com aten√ß√£o.");
  let total = getCookie("geneticScore") + score;
  setCookie("geneticScore", total);
  const btn = document.createElement("button");
  btn.textContent = "‚Ü©Ô∏è Retornar ao leitor QR";
  btn.onclick = returnToQR;
  final.appendChild(btn);
}

function returnToQR() {
  document.getElementById("chat-section").style.display = "none";
  document.getElementById("qr-section").style.display = "block";
  document.getElementById("dica").style.display = "none";
  updateTotalScore();
}

// ====== LEITOR DE QR CODE ======
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

async function startQR() {
  document.getElementById("qr-section").style.display = "block";
  updateTotalScore();
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  video.srcObject = stream;
  video.setAttribute("playsinline", true);
  video.style.display = "block";
  video.play();
  tick();
}

function tick() {
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.height = video.videoHeight;
    canvas.width = video.videoWidth;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(img.data, img.width, img.height);
    if (code) {
      const txt = code.data.trim();
      if (cases[txt]) startCase(txt);
      return;
    }
  }
  requestAnimationFrame(tick);
}

window.onload = startQR;
</script>
</body>
</html>
