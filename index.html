<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genetics RPG: Clinical Interview</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root {
            --bg-color: #2b2b2b;
            --screen-bg: #9bbc0f; /* Verde Gameboy Cl√°ssico */
            --screen-dark: #0f380f;
            --border-color: #333;
            --device-body: #c0c0c0;
            --accent: #8b0000;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'VT323', monospace;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--screen-dark);
            font-size: 22px; /* Fonte levemente maior para legibilidade */
        }

        /* O Dispositivo F√≠sico */
        .device-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--device-body);
            border-radius: 10px 10px 40px 10px;
            padding: 30px 20px 50px 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), inset -5px -5px 10px rgba(0,0,0,0.2);
            border: 2px solid #999;
            position: relative;
        }

        /* A Tela LCD */
        .screen-bezel {
            background-color: #555;
            padding: 20px 20px 5px 20px;
            border-radius: 10px 10px 30px 10px;
            margin-bottom: 20px;
            color: #ccc;
            text-align: center;
            font-size: 0.8rem;
        }

        .screen {
            background-color: var(--screen-bg);
            border: 4px solid var(--screen-dark);
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
            min-height: 550px;
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
        }

        /* --- ESTILOS DO SCANNER --- */
        #qr-screen {
            display: flex; /* Flexbox para centralizar */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        #reader {
            width: 250px;
            height: 250px;
            border: 4px dashed var(--screen-dark);
            margin: 10px auto;
            background: rgba(15, 56, 15, 0.1);
        }
        
        /* Ajustes para a biblioteca html5-qrcode */
        #reader video {
            object-fit: cover;
            border-radius: 4px;
        }

        .qr-help {
            font-size: 0.8rem;
            margin-top: 10px;
            color: var(--screen-dark);
            opacity: 0.8;
        }

        .qr-help a {
            color: var(--screen-dark);
            font-weight: bold;
        }

        /* --- INTERFACE DO JOGO --- */
        #game-screen {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid var(--screen-dark);
            margin-bottom: 10px;
            padding-bottom: 5px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 1rem;
        }

        /* Caixa de Di√°logo */
        .dialog-box {
            background-color: rgba(255,255,255,0.7);
            border: 2px solid var(--screen-dark);
            border-radius: 4px;
            padding: 10px;
            height: 130px;
            margin-bottom: 10px;
            position: relative;
            overflow-y: auto;
        }

        .dialog-arrow {
            position: absolute;
            bottom: 5px;
            right: 10px;
            animation: bounce 0.8s infinite;
            display: none;
            color: var(--accent);
            font-size: 1.5rem;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(3px); }
        }

        /* Escolhas */
        .choice-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn-rpg {
            background: transparent;
            border: 2px solid var(--screen-dark);
            color: var(--screen-dark);
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            padding: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.1s;
            box-shadow: 2px 2px 0px rgba(15, 56, 15, 0.5);
        }

        .btn-rpg:hover:not(:disabled) {
            background-color: var(--screen-dark);
            color: var(--screen-bg);
            transform: translate(-1px, -1px);
        }

        .btn-rpg:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-style: dashed;
        }

        .btn-full {
            width: 100%;
            text-align: center;
            margin-bottom: 5px;
        }

        /* Log de Respostas */
        .log-area {
            flex-grow: 1;
            border: 2px solid var(--screen-dark);
            background: rgba(255,255,255,0.4);
            padding: 5px;
            font-size: 0.9rem;
            overflow-y: auto;
            margin-bottom: 10px;
            height: 120px;
        }

        .log-entry {
            border-bottom: 1px dotted var(--screen-dark);
            padding: 3px 0;
        }

        /* Diagn√≥stico */
        .diagnosis-area {
            display: flex;
            gap: 5px;
        }

        select {
            font-family: 'VT323', monospace;
            background: var(--screen-bg);
            border: 2px solid var(--screen-dark);
            color: var(--screen-dark);
            flex-grow: 1;
            font-size: 1rem;
        }

        /* Feedback Overlay */
        #feedback-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 56, 15, 0.95);
            color: var(--screen-bg);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            z-index: 10;
        }

        #feedback-msg { margin: 20px 0; font-size: 1rem; }
        
        .correct { color: #fff; text-shadow: 2px 2px 0 #000; }
        .incorrect { color: #ffadad; }

    </style>
</head>
<body>

<div class="device-container">
    <div class="screen-bezel">
        GENETICS SIMULATOR V.1.0 ‚Ä¢ DOT MATRIX DISPLAY
    </div>
    
    <div class="screen">
        
        <div id="qr-screen">
            <h2>üîí ACESSO BLOQUEADO</h2>
            <p>APONTE A C√ÇMERA PARA O QR CODE DO PACIENTE <span id="target-case">1</span></p>
            
            <div id="reader"></div>
            
            <div class="qr-help">
                <p>Caso a c√¢mera n√£o abra:</p>
                <button class="btn-rpg" onclick="forceStartDebug()">[DEBUG] PULAR CAMERA</button>
            </div>

            <div class="qr-help" style="margin-top:20px; border-top: 1px dashed #000; padding-top:5px;">
                <strong>QR CODES PARA TESTE:</strong><br>
                <a href="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=CASO-1" target="_blank">Caso 1</a> | 
                <a href="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=CASO-2" target="_blank">Caso 2</a> | 
                <a href="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=CASO-3" target="_blank">Caso 3</a> <br>
                <a href="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=CASO-4" target="_blank">Caso 4</a> | 
                <a href="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=CASO-5" target="_blank">Caso 5</a>
            </div>
        </div>

        <div id="game-screen">
            <div class="status-bar">
                <span id="case-header">CASO 1</span>
                <span id="q-counter">Q: 0/10</span>
            </div>

            <div class="dialog-box" id="dialog-box">
                <span id="typewriter-text">Aguardando dados...</span>
                <div class="dialog-arrow" id="dialog-arrow">‚ñº</div>
            </div>

            <div class="choice-container">
                <button class="btn-rpg" id="btn-choice-a" onclick="makeChoice('A')">Op√ß√£o A</button>
                <button class="btn-rpg" id="btn-choice-b" onclick="makeChoice('B')">Op√ß√£o B</button>
            </div>

            <button class="btn-rpg btn-full" id="btn-hint" onclick="getHint()">üí° REVELAR DICA (0/3)</button>

            <div class="log-area" id="log-area">
                <div style="text-align: center; opacity: 0.6;">-- REGISTRO INICIADO --</div>
            </div>

            <div class="diagnosis-area">
                <select id="diagnosis-select">
                    <option value="">-- DIAGN√ìSTICO --</option>
                    <option value="Autoss√¥mica Dominante">Autoss√¥mica Dominante</option>
                    <option value="Autoss√¥mica Recessiva">Autoss√¥mica Recessiva</option>
                    <option value="Ligada ao X Dominante">Ligada ao X Dominante</option>
                    <option value="Ligada ao X Recessiva">Ligada ao X Recessiva</option>
                    <option value="Mitocondrial">Mitocondrial</option>
                </select>
                <button class="btn-rpg" onclick="submitDiagnosis()">OK</button>
            </div>
        </div>

        <div id="feedback-overlay">
            <h1 id="feedback-title">RESULTADO</h1>
            <div id="feedback-msg"></div>
            <button class="btn-rpg" style="background:white; color:black" id="btn-next-level" onclick="nextCase()">PR√ìXIMO</button>
            <button class="btn-rpg" style="background:transparent; color:white; border-color:white; margin-top:10px;" onclick="closeFeedback()">VOLTAR / REVISAR</button>
        </div>

    </div>
</div>

<script>
    // ==========================================
    // 1. DADOS (Fornecidos pelo Usu√°rio)
    // ==========================================
    const cases = [
        {
            id: 1,
            qrString: "CASO-1", // String que o QR Code deve conter
            patient: "Jo√£o, 35 anos, afetado (Homem)",
            inheritance: "Autoss√¥mica Dominante",
            data: {
                "pais-afetados": "O pai √© N√£o Afetado, mas a m√£e √© Afetada (transmiss√£o vertical).",
                "irmaos": "O paciente tem 1 irm√£ afetada e 1 irm√£o n√£o afetado.",
                "filhos": "O paciente (afetado) tem 2 filhos afetados e 1 filha n√£o afetada.",
                "generations": "O tra√ßo est√° presente em m√∫ltiplas gera√ß√µes consecutivas (transmiss√£o vertical).",
                "transmissao-pai-filho": "N√£o h√° transmiss√£o de pai para filho homem neste caso, mas o tra√ßo afeta ambos os sexos, sugerindo que o alelo n√£o est√° ligado ao Y.",
                "sexo-afetado": "Afeta homens e mulheres na mesma propor√ß√£o.",
                "consanguinidade": "N√£o h√° hist√≥rico de consanguinidade.",
                "filhas-pai": "A m√£e afetada transmite para filhos de ambos os sexos.",
            },
            hints: [
                "Sinais-chave: **Transmiss√£o Vertical** (todas as gera√ß√µes).",
                "A afeta√ß√£o ocorre em **ambos os sexos** e, frequentemente, 50% dos filhos de um progenitor afetado s√£o afetados.",
                "Doen√ßa: **Polidactilia**."
            ],
            explanation: "Correto! **Autoss√¥mica Dominante (AD)**. A transmiss√£o vertical (n√£o salta gera√ß√µes) e a afeta√ß√£o de ambos os sexos, com um progenitor afetado tendo filhos afetados, s√£o caracter√≠sticas de AD. 

[Image of Autosomal Dominant Pedigree]
"
        },
        {
            id: 2,
            qrString: "CASO-2",
            patient: "Maria, 28 anos, afetada (Mulher)",
            inheritance: "Autoss√¥mica Recessiva",
            data: {
                "pais-afetados": "Os pais da paciente s√£o **N√£o Afetados** (mas s√£o portadores).",
                "irmaos": "A paciente tem um irm√£o afetado e uma irm√£ n√£o afetada.",
                "filhos": "A paciente n√£o tem filhos.",
                "generations": "O tra√ßo **'saltou' gera√ß√µes** (nenhum dos pais √© afetado) - Transmiss√£o Horizontal.",
                "transmissao-pai-filho": "N√£o se aplica, pois os pais n√£o s√£o afetados.",
                "sexo-afetado": "Afeta homens e mulheres igualmente.",
                "consanguinidade": "N√£o h√° registro, mas a possibilidade √© maior neste padr√£o.",
                "filhas-pai": "Ambos os pais n√£o afetados tiveram filhos afetados (probabilidade de 25% por filho)."
            },
            hints: [
                "Sinais-chave: **Transmiss√£o Horizontal** ('salta' gera√ß√µes).",
                "Pais **n√£o afetados** (portadores) t√™m filhos afetados (25% de chance).",
                "Doen√ßa: **Fibrose C√≠stica**."
            ],
            explanation: "Correto! **Autoss√¥mica Recessiva (AR)**. O padr√£o de 'salto' de gera√ß√µes (pais n√£o afetados tendo filhos afetados) e a afeta√ß√£o de ambos os sexos s√£o as marcas da AR. 

[Image of Autosomal Recessive Pedigree]
"
        },
        {
            id: 3,
            qrString: "CASO-3",
            patient: "Pedro, 12 anos, afetado (Homem)",
            inheritance: "Ligada ao X Recessiva",
            data: {
                "pais-afetados": "O pai √© N√£o Afetado. A m√£e √© N√£o Afetada, mas √© **Portadora**.",
                "irmaos": "Pedro n√£o tem irm√£os afetados, mas tem um tio materno afetado.",
                "filhos": "N√£o se aplica.",
                "generations": "Aparece nos tios e no paciente (o gene passou pela m√£e/av√≥ portadora).",
                "transmissao-pai-filho": "**Nunca** h√° transmiss√£o de pai afetado para filho homem (o pai passa o cromossomo Y).",
                "sexo-afetado": "Afeta **quase exclusivamente homens**.",
                "consanguinidade": "N√£o h√° hist√≥rico.",
                "filhas-pai": "Um pai afetado ter√° todas as filhas portadoras (n√£o afetadas, se a m√£e n√£o for afetada)."
            },
            hints: [
                "Sinais-chave: Afeta **principalmente homens**.",
                "Transmiss√£o de **m√£e portadora para o filho**.",
                "Doen√ßa: **Hemofilia**."
            ],
            explanation: "Correto! **Ligada ao X Recessiva (X R)**. O padr√£o de afetar quase exclusivamente homens, a transmiss√£o por m√£es portadoras e a aus√™ncia de transmiss√£o de pai para filho homem s√£o cruciais para este diagn√≥stico. 

[Image of X-linked Recessive Pedigree]
"
        },
        {
            id: 4,
            qrString: "CASO-4",
            patient: "Ana, 40 anos, afetada (Mulher)",
            inheritance: "Mitocondrial",
            data: {
                "pais-afetados": "O pai √© N√£o Afetado. A m√£e √© **Afetada**.",
                "irmaos": "A paciente tem uma irm√£ afetada e um irm√£o **n√£o afetado** (embora a m√£e seja afetada).",
                "filhos": "A paciente (afetada) tem 3 filhos e 3 filhas, **TODOS afetados**.",
                "generations": "Presente em todas as gera√ß√µes, mas **apenas via linha materna**.",
                "transmissao-pai-filho": "**Nunca** h√° transmiss√£o por pais afetados (apenas mitoc√¥ndrias maternas s√£o passadas).",
                "sexo-afetado": "Afeta ambos os sexos, mas **somente a m√£e transmite**.",
                "consanguinidade": "N√£o relevante.",
                "filhas-pai": "Pais afetados n√£o transmitem o tra√ßo."
            },
            hints: [
                "Sinais-chave: Transmiss√£o **EXCLUSIVAMENTE Materna**.",
                "Uma m√£e afetada transmite o tra√ßo para **TODOS os seus filhos** (homens e mulheres).",
                "Doen√ßa: **Miopatia Mitocondrial**."
            ],
            explanation: "Correto! **Mitocondrial**. O crit√©rio definidor √© a transmiss√£o exclusiva pela m√£e para todos os seus descendentes, enquanto o pai afetado n√£o transmite a condi√ß√£o. "
        },
        {
            id: 5,
            qrString: "CASO-5",
            patient: "Sofia, 8 anos, afetada (Mulher)",
            inheritance: "Ligada ao X Dominante",
            data: {
                "pais-afetados": "O pai √© N√£o Afetado. A m√£e √© **Afetada**.",
                "irmaos": "A paciente tem uma irm√£ afetada e um irm√£o n√£o afetado.",
                "filhos": "N√£o se aplica.",
                "generations": "Transmiss√£o vertical, com a av√≥ materna tamb√©m afetada.",
                "transmissao-pai-filho": "Um pai afetado **transmite a TODAS as suas filhas**, mas a **NENHUM dos seus filhos**.",
                "sexo-afetado": "Afeta **mais mulheres** que homens.",
                "consanguinidade": "N√£o relevante.",
                "filhas-pai": "Se o pai fosse afetado, todas as filhas seriam afetadas."
            },
            hints: [
                "Sinais-chave: Afeta **mais mulheres** que homens e √© vertical.",
                "Regra de Ouro: Um pai afetado transmite a doen√ßa a **TODAS as filhas**.",
                "Doen√ßa: **S√≠ndrome de Rett** (comum ser letal em homens homozigotos)."
            ],
            explanation: "Correto! **Ligada ao X Dominante (X D)**. A transmiss√£o vertical (n√£o salta gera√ß√µes), o fato de afetar mais mulheres e a regra de que o pai afetado passa o tra√ßo para todas as filhas s√£o decisivos. 

[Image of X-linked Dominant Pedigree]
"
        }
    ];

    // Banco de Perguntas (Exatamente como fornecido)
    const questionTemplates = [
        { q: "Qual o status de afeta√ß√£o dos pais do paciente?", key: "pais-afetados" },
        { q: "O paciente tem irm√£os? Qual o status de afeta√ß√£o deles?", key: "irmaos" },
        { q: "O paciente tem filhos? Qual o status de afeta√ß√£o deles?", key: "filhos" },
        { q: "O tra√ßo aparece em todas as gera√ß√µes (Transmiss√£o Vertical)?", key: "generations" },
        { q: "Existe transmiss√£o de pai afetado para filho homem afetado?", key: "transmissao-pai-filho" },
        { q: "O padr√£o de afeta√ß√£o √© exclusivo ou majorit√°rio em um sexo?", key: "sexo-afetado" },
        { q: "Existe hist√≥rico de consanguinidade na fam√≠lia?", key: "consanguinidade" },
        { q: "Como um pai afetado transmite o tra√ßo para filhas versus filhos?", key: "filhas-pai" },
    ];

    // ==========================================
    // 2. CONTROLE DO JOGO
    // ==========================================
    let currentCaseIndex = 0;
    let questionsUsed = 0;
    let askedKeys = [];
    let currentOptions = []; // As duas op√ß√µes atuais
    let hintLevel = 0;
    let html5QrcodeScanner = null;

    // Elementos DOM
    const qrScreen = document.getElementById('qr-screen');
    const gameScreen = document.getElementById('game-screen');
    const feedbackOverlay = document.getElementById('feedback-overlay');
    const typebox = document.getElementById('typewriter-text');
    const arrow = document.getElementById('dialog-arrow');
    const btnA = document.getElementById('btn-choice-a');
    const btnB = document.getElementById('btn-choice-b');
    const logArea = document.getElementById('log-area');
    
    // --- L√ìGICA DO QR CODE ---
    function initScanner() {
        if (html5QrcodeScanner) return; // J√° iniciado

        html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { fps: 10, qrbox: {width: 200, height: 200} },
            /* verbose= */ false
        );
        
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Code matched = ${decodedText}`);
        
        // Verifica se o QR code corresponde ao caso atual
        const expectedString = cases[currentCaseIndex].qrString;
        
        // Permitir flexibilidade (se o texto cont√©m a string esperada)
        if (decodedText.includes(expectedString) || decodedText.includes(`CASO-${currentCaseIndex+1}`)) {
            html5QrcodeScanner.clear().then(_ => {
                startGame();
            }).catch(error => {
                console.error("Falha ao limpar scanner.", error);
                startGame(); // Tenta iniciar mesmo assim
            });
        } else {
            alert(`QR Code incorreto! Esperado: Caso ${currentCaseIndex + 1}. Lido: ${decodedText}`);
        }
    }

    function onScanFailure(error) {
        // Nada a fazer, apenas continua scaneando
    }

    function forceStartDebug() {
        // Fun√ß√£o de fallback para testes sem c√¢mera
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear();
        }
        startGame();
    }

    // --- L√ìGICA DA ENTREVISTA ---
    
    function startGame() {
        qrScreen.style.display = 'none';
        gameScreen.style.display = 'flex';
        
        // Reset Vari√°veis
        questionsUsed = 0;
        askedKeys = [];
        hintLevel = 0;
        logArea.innerHTML = '<div style="text-align: center; opacity: 0.6;">-- REGISTRO INICIADO --</div>';
        document.getElementById('diagnosis-select').value = "";
        document.getElementById('case-header').textContent = `CASO ${currentCaseIndex + 1}`;
        updateStatus();
        document.getElementById('btn-hint').textContent = `üí° REVELAR DICA (0/3)`;

        // Intro do Paciente
        const intro = `PACIENTE: ${cases[currentCaseIndex].patient}. "Ol√° doutor(a), preciso entender minha gen√©tica."`;
        typeText(intro, generateOptions);
    }

    function updateStatus() {
        document.getElementById('q-counter').textContent = `Q: ${questionsUsed}/10`;
    }

    // Efeito de Digita√ß√£o
    let typeInterval;
    function typeText(text, callback) {
        typebox.innerHTML = "";
        arrow.style.display = "none";
        btnA.disabled = true;
        btnB.disabled = true;

        let i = 0;
        clearInterval(typeInterval);
        typeInterval = setInterval(() => {
            typebox.innerHTML += text.charAt(i);
            i++;
            if (i >= text.length) {
                clearInterval(typeInterval);
                arrow.style.display = "block";
                btnA.disabled = false;
                btnB.disabled = false;
                if(callback) callback();
            }
        }, 20); // Velocidade
    }

    function generateOptions() {
        if (questionsUsed >= 10) {
            typeText("PACIENTE: 'Acho que j√° falei tudo que sabia, doutor(a).'");
            btnA.style.display = 'none';
            btnB.style.display = 'none';
            return;
        }

        // Filtra perguntas ainda n√£o feitas
        const available = questionTemplates.filter(t => !askedKeys.includes(t.key));
        
        if (available.length < 2) {
            // Se sobrarem poucas perguntas (ex: apenas 1), mostra ela e um placeholder ou encerra
            if(available.length === 1) {
                currentOptions = [available[0], null];
                btnA.textContent = "‚û§ " + available[0].q;
                btnB.style.display = 'none';
                btnA.style.display = 'block';
                return;
            }
            typeText("PACIENTE: 'N√£o tenho mais informa√ß√µes.'");
            btnA.style.display = 'none';
            btnB.style.display = 'none';
            return;
        }

        // Seleciona 2 aleat√≥rias
        const shuffled = available.sort(() => 0.5 - Math.random());
        currentOptions = [shuffled[0], shuffled[1]];

        btnA.style.display = 'block';
        btnB.style.display = 'block';
        btnA.textContent = "‚û§ " + currentOptions[0].q;
        btnB.textContent = "‚û§ " + currentOptions[1].q;
    }

    function makeChoice(choice) {
        const selectedObj = choice === 'A' ? currentOptions[0] : currentOptions[1];
        if (!selectedObj) return;

        // Registrar uso
        questionsUsed++;
        askedKeys.push(selectedObj.key);
        updateStatus();

        // Obter resposta
        const answer = cases[currentCaseIndex].data[selectedObj.key] || "Informa√ß√£o indispon√≠vel.";

        // Adicionar ao Log
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `<strong>P:</strong> ${selectedObj.q}<br><strong>R:</strong> ${answer}`;
        logArea.appendChild(entry);
        logArea.scrollTop = logArea.scrollHeight;

        // Mostrar resposta com efeito
        typeText(`PACIENTE: "${answer}"`, () => {
            // Pequeno delay antes de gerar novas
            setTimeout(generateOptions, 800);
        });
    }

    function getHint() {
        const currentCase = cases[currentCaseIndex];
        if (hintLevel >= currentCase.hints.length) {
            typeText("SISTEMA: Nenhuma dica adicional dispon√≠vel.");
            return;
        }

        const hint = currentCase.hints[hintLevel];
        hintLevel++;
        document.getElementById('btn-hint').textContent = `üí° REVELAR DICA (${hintLevel}/${currentCase.hints.length})`;

        // Log da Dica
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.style.background = "#fff3cd";
        entry.innerHTML = `<strong>üí° DICA:</strong> ${hint}`;
        logArea.appendChild(entry);
        logArea.scrollTop = logArea.scrollHeight;

        typeText(`SISTEMA (DICA REVELADA): ${hint}`);
    }

    // --- DIAGN√ìSTICO E FIM DE FASE ---

    function submitDiagnosis() {
        const selected = document.getElementById('diagnosis-select').value;
        if (!selected) return;

        const currentCase = cases[currentCaseIndex];
        const correct = currentCase.inheritance;

        feedbackOverlay.style.display = 'flex';
        const title = document.getElementById('feedback-title');
        const msg = document.getElementById('feedback-msg');
        const nextBtn = document.getElementById('btn-next-level');

        if (selected === correct) {
            title.textContent = "‚úÖ DIAGN√ìSTICO CORRETO";
            title.className = "correct";
            msg.innerHTML = currentCase.explanation;
            nextBtn.style.display = "inline-block";
        } else {
            title.textContent = "‚ùå DIAGN√ìSTICO INCORRETO";
            title.className = "incorrect";
            msg.innerHTML = `Voc√™ selecionou: <strong>${selected}</strong>.<br><br>Revise suas anota√ß√µes ou use uma dica.`;
            nextBtn.style.display = "none";
        }
    }

    function closeFeedback() {
        feedbackOverlay.style.display = 'none';
    }

    function nextCase() {
        closeFeedback();
        currentCaseIndex++;
        
        if (currentCaseIndex >= cases.length) {
            alert("PARAB√âNS! VOC√ä FINALIZOU TODOS OS CASOS!");
            currentCaseIndex = 0;
        }

        // Volta para a tela de QR
        gameScreen.style.display = 'none';
        qrScreen.style.display = 'flex';
        document.getElementById('target-case').textContent = currentCaseIndex + 1;
        
        // Reinicia scanner
        initScanner();
    }

    // Inicializa√ß√£o
    window.onload = function() {
        initScanner();
    };

</script>

</body>
</html>
