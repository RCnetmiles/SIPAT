<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heran√ßa Gen√©tica - Simulador</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: linear-gradient(135deg, #eff6ff, #dbeafe);
    margin: 0;
    color: #1e3a8a;
  }
  .container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
  }
  h1, h2 {
    text-align: center;
  }
  #qr-section, #chat-section {
    display: none;
  }
  #chat {
    background: white;
    border-radius: 10px;
    padding: 10px;
    height: 400px;
    overflow-y: auto;
    border: 1px solid #cbd5e1;
  }
  .message {
    margin: 10px 0;
    padding: 10px 14px;
    border-radius: 16px;
    max-width: 80%;
  }
  .npc { background: #e0e7ff; align-self: flex-start; }
  .user { background: #bfdbfe; margin-left: auto; }
  #options button, #final-options button {
    display: block;
    width: 100%;
    margin: 6px 0;
    padding: 10px;
    border: none;
    border-radius: 10px;
    background-color: #3b82f6;
    color: white;
    font-weight: 500;
    cursor: pointer;
  }
  #options button:hover, #final-options button:hover {
    background-color: #2563eb;
  }
  .typing { font-style: italic; color: #6b7280; }
  #score {
    text-align: center;
    margin-bottom: 10px;
    font-size: 18px;
    color: #0f172a;
  }
  #dica {
    background-color: #fef9c3;
    border: 1px solid #facc15;
    padding: 10px;
    border-radius: 10px;
    margin: 10px 0;
    display: none;
    text-align: center;
  }
  @media (max-width: 600px) {
    #chat { height: 60vh; }
  }
</style>
</head>
<body>
<div class="container">
  <h1>üß¨ Heran√ßa Gen√©tica</h1>
  <div id="qr-section">
    <h2>Leitor de QR Code</h2>
    <p>Pontua√ß√£o total: <strong id="total-score">0 pts</strong></p>
    <p>Escaneie um QR Code ou selecione um caso para testar:</p>
    <button onclick="startCase('case1')">Caso Cl√≠nico 1</button>
    <button onclick="startCase('case2')">Caso Cl√≠nico 2</button>
  </div>

  <div id="chat-section">
    <h2 id="case-title"></h2>
    <div id="chat"></div>
    <div id="options"></div>
    <div id="dica"></div>
    <div id="final-options"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
const cases = {
  case1: {
    title: "Caso Cl√≠nico 1 - Fraqueza Muscular Progressiva",
    type: "Ligada ao X Recessiva",
    questions: [
      { q: "Algum dos pais √© afetado?", a: "Nenhum dos pais apresenta sintomas vis√≠veis." },
      { q: "A m√£e ou o pai s√£o portadores conhecidos?", a: "A m√£e √© portadora confirmada da muta√ß√£o." },
      { q: "H√° outros casos na fam√≠lia materna?", a: "Sim, dois tios maternos apresentaram os mesmos sintomas." },
      { q: "H√° diferen√ßa entre meninos e meninas?", a: "A condi√ß√£o √© observada apenas em meninos da fam√≠lia." },
      { q: "As meninas apresentam sintomas?", a: "As meninas geralmente n√£o t√™m sintomas, mas podem ser portadoras." },
      { q: "H√° casos em gera√ß√µes anteriores?", a: "O av√¥ materno teve sintomas semelhantes na juventude." },
      { q: "Algum caso vem do lado paterno?", a: "No lado paterno n√£o h√° registros da condi√ß√£o." },
      { q: "O paciente tem irm√£os afetados?", a: "Sim, o irm√£o mais velho apresenta sintomas semelhantes." }
    ],
    dica: "Os meninos afetados herdaram o gene mutado de m√£es portadoras. Pense em uma heran√ßa ligada ao cromossomo X (recessiva)."
  },
  case2: {
    title: "Caso Cl√≠nico 2 - Altera√ß√µes Cut√¢neas e Auditivas",
    type: "Autoss√¥mica Dominante",
    questions: [
      { q: "Algum dos pais apresenta sintomas semelhantes?", a: "Sim, o pai tamb√©m apresenta manchas cut√¢neas e perda auditiva leve." },
      { q: "H√° casos em todas as gera√ß√µes?", a: "Sim, pelo menos um membro afetado em cada gera√ß√£o." },
      { q: "Homens e mulheres s√£o igualmente afetados?", a: "Sim, ambos os sexos apresentam a condi√ß√£o com frequ√™ncia semelhante." },
      { q: "H√° indiv√≠duos portadores sem sintomas?", a: "N√£o, quem tem o gene manifesta algum grau da condi√ß√£o." },
      { q: "H√° casamentos entre parentes?", a: "N√£o h√° registros de consanguinidade." },
      { q: "A condi√ß√£o tende a piorar nas gera√ß√µes seguintes?", a: "N√£o, a gravidade √© semelhante entre gera√ß√µes." },
      { q: "H√° g√™meos com diferentes manifesta√ß√µes?", a: "Sim, g√™meos id√™nticos t√™m intensidade diferente dos sintomas." },
      { q: "Algu√©m foi adotado?", a: "N√£o, todos os membros s√£o biol√≥gicos." }
    ],
    dica: "A condi√ß√£o aparece em todas as gera√ß√µes, afetando homens e mulheres igualmente. Isso indica uma heran√ßa autoss√¥mica dominante."
  }
};

let selectedCase = null;
let asked = [];
let step = 0;
let usedDica = false;
let score = 0;

function getCookie(name) {
  const match = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return match ? parseInt(match.pop()) : 0;
}
function setCookie(name, value) {
  document.cookie = `${name}=${value}; path=/; max-age=31536000`;
}

function updateTotalScore() {
  document.getElementById("total-score").textContent = `${getCookie("geneticScore")} pts`;
}

function startCase(id) {
  selectedCase = cases[id];
  asked = [];
  step = 0;
  usedDica = false;
  score = 0;
  document.getElementById("qr-section").style.display = "none";
  document.getElementById("chat-section").style.display = "block";
  document.getElementById("case-title").textContent = selectedCase.title;
  document.getElementById("chat").innerHTML = "";
  document.getElementById("options").innerHTML = "";
  appendMessage("npc", "Ol√°! üëã Sou seu assistente gen√©tico. Voc√™ pode fazer at√© 6 perguntas sobre a fam√≠lia deste paciente. Escolha bem!");
  nextQuestion();
}

function appendMessage(sender, text) {
  const div = document.createElement("div");
  div.classList.add("message", sender);
  div.textContent = text;
  document.getElementById("chat").appendChild(div);
  document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
}

function nextQuestion() {
  const options = document.getElementById("options");
  options.innerHTML = "";

  if (step >= 6) {
    showFinalOptions();
    return;
  }

  let remaining = selectedCase.questions.filter((_, i) => !asked.includes(i));
  remaining.forEach((item, i) => {
    const btn = document.createElement("button");
    btn.textContent = item.q;
    btn.onclick = () => selectQuestion(i, remaining);
    options.appendChild(btn);
  });
}

function selectQuestion(index, remaining) {
  const questionIndex = selectedCase.questions.findIndex(q => q.q === remaining[index].q);
  asked.push(questionIndex);
  appendMessage("user", remaining[index].q);
  typeWriter(selectedCase.questions[questionIndex].a, () => {
    step++;
    nextQuestion();
  });
}

function typeWriter(text, callback) {
  const chat = document.getElementById("chat");
  const typing = document.createElement("div");
  typing.classList.add("typing");
  typing.textContent = "NPC est√° digitando...";
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;

  setTimeout(() => {
    chat.removeChild(typing);
    appendMessage("npc", text);
    if (callback) callback();
  }, 1200 + Math.random() * 800);
}

function showFinalOptions() {
  const options = document.getElementById("options");
  options.innerHTML = "";
  const final = document.getElementById("final-options");
  final.innerHTML = "<h3>Qual o tipo de heran√ßa gen√©tica?</h3>";

  ["Autoss√¥mica Dominante", "Autoss√¥mica Recessiva", "Ligada ao X Recessiva", "Ligada ao X Dominante"].forEach(type => {
    const btn = document.createElement("button");
    btn.textContent = type;
    btn.onclick = () => verifyAnswer(type);
    final.appendChild(btn);
  });

  const dicaBtn = document.createElement("button");
  dicaBtn.textContent = "üí° Mostrar Dica";
  dicaBtn.onclick = showDica;
  final.appendChild(dicaBtn);
}

function showDica() {
  usedDica = true;
  const dicaDiv = document.getElementById("dica");
  dicaDiv.style.display = "block";
  dicaDiv.textContent = "üí° Dica: " + selectedCase.dica;
}

function verifyAnswer(answer) {
  const final = document.getElementById("final-options");
  final.innerHTML = "";
  let correct = (answer === selectedCase.type);
  score = correct ? (usedDica ? 50 : 100) : 0;
  appendMessage("npc", correct ? "‚úÖ Correto! Excelente trabalho!" : "‚ùå Resposta incorreta. Reveja as pistas com aten√ß√£o.");

  let total = getCookie("geneticScore") + score;
  setCookie("geneticScore", total);

  const btn = document.createElement("button");
  btn.textContent = "‚Ü©Ô∏è Retornar ao leitor QR";
  btn.onclick = returnToQR;
  final.appendChild(btn);
}

function returnToQR() {
  document.getElementById("chat-section").style.display = "none";
  document.getElementById("qr-section").style.display = "block";
  document.getElementById("dica").style.display = "none";
  updateTotalScore();
}

window.onload = () => {
  document.getElementById("qr-section").style.display = "block";
  updateTotalScore();
};
</script>
</body>
</html>
